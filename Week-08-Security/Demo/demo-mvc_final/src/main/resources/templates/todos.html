<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Todos</title>
</head>
<body>
<div th:replace="fragments/layout :: layout(~{::section})">
    <section>
        <div style="display:flex; align-items:center; justify-content:space-between;">
            <h1 style="margin:0;">Todos</h1>
            <div>
                <a class="button" th:href="@{/todos/new}">+ Create Todo</a>
                <span> | </span>
                <a class="button" th:href="@{/todos/lists/new}">+ Create List</a>
            </div>
        </div>

        <!-- Flash errors -->
        <div th:if="${error}" style="margin: 1rem 0; color: #b00020;">
            <strong th:text="${error}">Error</strong>
        </div>

        <!-- Filters -->
        <nav style="margin: 1rem 0;">
            <a th:href="@{/todos(filter='all')}" th:classappend="${filter}=='all' ? 'active' : ''">All</a>
            |
            <a th:href="@{/todos(filter='open')}" th:classappend="${filter}=='open' ? 'active' : ''">Open</a>
            |
            <a th:href="@{/todos(filter='done')}" th:classappend="${filter}=='done' ? 'active' : ''">Done</a>
        </nav>

        <!-- Grouped by list -->
        <div th:if="${#lists.isEmpty(todoLists)}">
            <p><em>No lists yet. Create a list to organize your todos.</em></p>
        </div>

        <ul th:if="${!#lists.isEmpty(todoLists)}" style="list-style:none; padding:0;">
            <li th:each="list : ${todoLists}">
                <div style="display:flex; align-items:center; justify-content:space-between;">
                    <h2 style="margin:0;">
                        <span th:text="${list.name}">List Name</span>
                        <small>#<span th:text="${list.id}">id</span></small>
                        <span style="font-size:0.9em; color:#666; margin-left:0.5rem;">
                            <span th:if="${#lists.isEmpty(listTodosByListId[list.id])}">(0 items)</span>
                            <span th:unless="${#lists.isEmpty(listTodosByListId[list.id])}"
                                  th:text="|(${#lists.size(listTodosByListId[list.id])} items)|"></span>
                        </span>
                    </h2>
                </div>

                <div th:if="${#lists.isEmpty(listTodosByListId[list.id])}">
                    <em>No todos in this list for the selected filter.</em>
                </div>
                <ul th:if="${!#lists.isEmpty(listTodosByListId[list.id])}" style="list-style:none; padding:0;">
                    <li th:each="todo : ${listTodosByListId[list.id]}" style="border:1px solid #ddd; padding:8px; margin-bottom:8px;">
                        <div style="display:flex; align-items:center; justify-content:space-between; gap:1rem; flex-wrap:wrap;">
                            <div>
                                <span>#<span th:text="${todo.id}">1</span></span>
                                <span style="margin-left:0.5rem;" th:text="${todo.text}">Todo text</span>
                                <strong style="margin-left:0.5rem;" th:text="${todo.done} ? '✓' : '✗'">done?</strong>
                            </div>
                            <div style="display:flex; align-items:center; gap:0.5rem;">
                                <!-- Toggle done -->
                                <form th:action="@{'/todos/' + ${todo.id} + '/toggle'}" method="post">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                    <input type="hidden" name="filter" th:value="${filter}"/>
                                    <button type="submit" th:text="${todo.done} ? 'Mark Undone' : 'Mark Done'"></button>
                                </form>

                                <!-- Assign to list -->
                                <form th:action="@{'/todos/' + ${todo.id} + '/assign'}" method="post">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                    <input type="hidden" name="filter" th:value="${filter}"/>
                                    <label>
                                        <span style="margin-right:0.25rem; color:#555;">Move to:</span>
                                        <select name="listId">
                                            <option value="" th:selected="${todoListByTodoId[todo.id]} == null">None</option>
                                            <option th:each="l : ${todoLists}"
                                                    th:value="${l.id}"
                                                    th:text="${l.name}"
                                                    th:selected="${todoListByTodoId[todo.id]} == l.id"></option>
                                        </select>
                                    </label>
                                    <button type="submit">Apply</button>
                                </form>

                                <!-- Delete todo -->
                                <form th:action="@{'/todos/' + ${todo.id} + '/delete'}" method="post" onsubmit="return confirm('Delete this todo?');">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                    <input type="hidden" name="filter" th:value="${filter}"/>
                                    <button type="submit">Delete</button>
                                </form>
                            </div>
                        </div>
                    </li>
                </ul>
                <div>
                    <form th:action="@{'/todos/lists/' + ${list.id} + '/delete'}" method="post"
                          onsubmit="return confirm('Delete this list? It must be empty.');">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <input type="hidden" name="filter" th:value="${filter}"/>
                        <button type="submit">Delete List</button>
                    </form>
                </div>
                <hr/>
            </li>
        </ul>

        <!-- Unlisted todos section -->
        <section>
            <h2>Todos without any list</h2>
            <div th:if="${#lists.isEmpty(unlistedTodos)}">
                <em>No standalone todos for the selected filter.</em>
            </div>
            <ul th:if="${!#lists.isEmpty(unlistedTodos)}" style="list-style:none; padding:0;">
                <li th:each="todo : ${unlistedTodos}" style="border:1px solid #ddd; padding:8px; margin-bottom:8px;">
                    <div style="display:flex; align-items:center; justify-content:space-between; gap:1rem; flex-wrap:wrap;">
                        <div>
                            <span>#<span th:text="${todo.id}">1</span></span>
                            <span style="margin-left:0.5rem;" th:text="${todo.text}">Todo text</span>
                            <strong style="margin-left:0.5rem;" th:text="${todo.done} ? '✓' : '✗'">done?</strong>
                        </div>
                        <div style="display:flex; align-items:center; gap:0.5rem;">
                            <!-- Toggle done -->
                            <form th:action="@{'/todos/' + ${todo.id} + '/toggle'}" method="post">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                <input type="hidden" name="filter" th:value="${filter}"/>
                                <button type="submit" th:text="${todo.done} ? 'Mark Undone' : 'Mark Done'"></button>
                            </form>

                            <!-- Assign to list -->
                            <form th:action="@{'/todos/' + ${todo.id} + '/assign'}" method="post">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                <input type="hidden" name="filter" th:value="${filter}"/>
                                <label>
                                    <span style="margin-right:0.25rem; color:#555;">Move to:</span>
                                    <select name="listId">
                                        <option value="" th:selected="${todoListByTodoId[todo.id]} == null">None</option>
                                        <option th:each="l : ${todoLists}"
                                                th:value="${l.id}"
                                                th:text="${l.name}"
                                                th:selected="${todoListByTodoId[todo.id]} == l.id"></option>
                                    </select>
                                </label>
                                <button type="submit">Apply</button>
                            </form>

                            <!-- Delete todo -->
                            <form th:action="@{'/todos/' + ${todo.id} + '/delete'}" method="post" onsubmit="return confirm('Delete this todo?');">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                <input type="hidden" name="filter" th:value="${filter}"/>
                                <button type="submit">Delete</button>
                            </form>
                        </div>
                    </div>
                </li>
            </ul>
        </section>
    </section>
</div>
</body>
</html>